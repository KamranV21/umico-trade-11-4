## Интеграция 1С и Umico

Расширение разработано под конфигурацию УТ 11.4 и позволяет обмениваться данными с Umico POS API версии 1.0, а именно:
- Получать информацию об актуальном состоянии бонусных баллов на карте Umico
- Начислять бонусные баллы на карту Umico за покупку
- Принимать оплату за счет бонусных баллов
- Оформлять возврат бонусных баллов
- Просматривать текущий статус обработки транзакций на серверах Umico

В интеграции участвуют как оптовые документы ("Реализация товаров и услуг", "Возврат товаров от клиента"), так и розничные ("Чек ККМ" и "Чек ККМ на возврат").

## 1. Настройка обмена

Настройки обмена указываются в справочнике "Параметры подключения к Umico" подсистемы "Umico". В элементе справочника необходимо заполнить значение токена авторизации API key и интеграционный код торговой точки продаж (POS ID). Оба значения можно узнать у менеджера по работе с партнерами Umico или в личном кабинете Umico. На этой же форме указывается вариант использования параметров подключения - для оптовых продаж или для розничных. В случае использования для оптовых продаж требуется указать пользователя системы, за которым будут закреплены данные параметры. В случае же использования для розничных продаж нужно указать кассу ККМ.

 ![image](https://github.com/user-attachments/assets/0d0c7dd3-2a41-475e-becf-fbb1723c661f)

Обратите внимание, что для  работы с розничными документами рекомендуется архивировать чеки ККМ, а не удалять их после закрытия кассовой смены. Это значительно облегчит процесс передачи данных о возврате в Umico. Также убедитесь, что установленная валюта управленческого учета соответствует реальной валюте, используемой при расчете с клиентами, так как информация о ней будет использоваться при передаче данных в Umico.

При добавлении расширения не забудьте отключить безопасный режим работы.

## 2. Порядок действий при работе с розничными документами

### 2.1. Продажа
 
После включения расширения в обработке рабочего места кассира появляется кнопка "Карта Umico", при нажатии на которую открывается форма ввода номера карты Umico. Если номер был указан корректно, то при пробитии чека информация о продаже будет передана на сервер Umico, в результате чего на карту клиента будут зачислены бонусные баллы. 

![image](https://github.com/user-attachments/assets/7cef2615-7c1d-4c7c-8883-760623e75611)
 
Также предусмотрена и возможность оплаты чека бонусными баллами Umico. Для этого нужно воспользоваться командой формы "Смешанная оплата". Помимо стандартных вариантов оплаты - наличными, безналичными и т.д. - на форме появляется также команда "Оплатить баллами Umico". При нажатии на данную кнопку открывается форма ввода номера карты (если номер карты уже был введен прежде, то он заполнится автоматически). Указав номер, необходимо нажать на команду "Получить сведения", после чего в заголовке формы отобразится текущий доступный к списанию остаток бонусов на карте, а сама форма перейдет в режим ввода суммы баллов. После ввода суммы балов и нажатия на кнопку "ОК", необходимо вернуться в форму ввода смешанной оплаты, при этом теперь общая сумма к оплате покупателем будет уменьшена на введенную в предыдущей форме сумму баллов.
 
![image](https://github.com/user-attachments/assets/4be3b838-1d5a-41c3-83a1-9b720f2c1610)

### 2.2 Возврат

При оформлении чека ККМ на возврат номер карты Umico заполняется автоматически на основании чека продажи. Так как чек продажи мог быть частично оплачен бонусными баллами Umico, то при оформлении возврата эти баллы будут возвращены на карту покупателя. Следовательно, в таком случае денежными средствами необходимо вернуть не всю сумму чека, а только сумму чека за вычетом бонусных баллов к возврату. При этом сумма бонусных баллов к возврату рассчитывается на стороне Umico. Запрос для расчета бонусных баллов к возврату происходит прямо во время нажатия кнопки "Оплатить наличными" или "Смешанная оплата". Если запрос был выполнен успешно, то сумма к оплате автоматически уменьшится на сумму баллов.
 
![image](https://github.com/user-attachments/assets/ccd72ad8-40d2-4295-841e-bc0ec460e5dc)

Обратите внимание, если по какой-то причине сумму баллов к возврату не удалось рассчитать, то соответствующее предупреждение будет выведено пользователю. Будьте осторожны, так как в таком случае можно по ошибке вернуть покупателю ту сумму денежных средств, которая и так будет зачислена ему на карту Umico.

## 3. Порядок действий при работе с оптовыми документами

### 3.1. Продажа
 
Оптовая продажа осуществляется документом "Реализация товаров и услуг", на форме которой при включении расширения появляется дополнительная вкладка Umico, на которой размещены реквизиты ввода номера карты и суммы баллов. После ввода данных и проведения документа данные о продаже клиенту можно передать на сервер Umico. Делается это посредством команды "Отправить документ в Umico". Если операция передачи данных прошла успешно, то информация об этом будет отображена в надписи статуса.
При оплате бонусными баллами сумма задолженности клиента по документу должна уменьшится на соответствующую сумму. Для реализации этой цели в форму документа реализации выведена команда "Списать задолженность по Umico", которая создает документ списания задолженности на сумму бонусных баллов Umico.
 
![image](https://github.com/user-attachments/assets/6ad715d7-f351-435a-8485-c3123df29a29)

### 3.2. Возврат

При оформлении возврата товаров от клиента номер карты Umico заполняется автоматически на основании документа реализации. Так же как и в случае с розничными документами, если реализация была частично оплачена бонусными баллами Umico, то при оформлении возврата эти баллы будут возвращены на карту покупателя. Следовательно, в таком случае денежными средствами необходимо вернуть не всю сумму чека, а только сумму чека за вычетом бонусных баллов к возврату. При этом сумма бонусных баллов к возврату рассчитывается на стороне Umico. Для расчета бонусных баллов к возврату необходимо нажать на кнопку "Рассчитать сумму оплаты баллами Umico". После предварительного расчета суммы возврата бонусными баллами данные о продаже клиенту можно передать на сервер Umico. Делается это посредством команды "Отправить документ в Umico". Если операция передачи данных прошла успешно, то информация об этом будет отображена в надписи статуса.
При возврате бонусными баллами сумма задолженности перед клиентом по документу должна уменьшится на соответствующую сумму. Для реализации этой цели в форму документа возврата выведена команда "Списать задолженность по Umico", которая создает документ списания задолженности на сумму бонусных баллов Umico.

## 4. Техническая информация

У каждой транзакции Umico, будь то реализация или возврат, имеется свой уникальный идентификатор и статус. Информация по ним хранится в регистре сведений "Идентификаторы чеков Umico".
 
![image](https://github.com/user-attachments/assets/d9fc33e3-4185-4ebf-bf00-9461c39817eb)

Кроме этого история каждого HTTP-запроса на сервер Umico сохраняется в справочнике "Журнал запросов к Umico", в котором содержится информация о выполняемой команде, пользователе, выполнившим действие, тело запрос и ответа, а также ссылка на связанный документ.
 
![image](https://github.com/user-attachments/assets/5d138f0f-a87d-490f-bb66-528f6a610db9)



